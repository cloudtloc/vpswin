name: Windows RDP (Optimized)
on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    env:
      NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
      # Mật khẩu RDP phải đủ mạnh theo chính sách Windows
      RDP_PASSWORD: Win2026A!
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        shell: pwsh
        run: |
          if (-not $env:NGROK_AUTHTOKEN) {
            Write-Error "Error: NGROK_AUTHTOKEN is missing in Secrets"
            exit 1
          }

      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup 'Remote Desktop' -ErrorAction SilentlyContinue
          New-NetFirewallRule -DisplayName 'RDP 3389' -Direction Inbound -Protocol TCP -LocalPort 3389 -Action Allow -ErrorAction SilentlyContinue
          net user Administrator $env:RDP_PASSWORD
          Write-Host "RDP enabled."

      - name: Install ngrok
        shell: pwsh
        run: |
          $ngrokZip = "$env:RUNNER_TEMP\ngrok.zip"
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile $ngrokZip -UseBasicParsing
          Expand-Archive -Path $ngrokZip -DestinationPath $env:RUNNER_TEMP -Force
          $env:PATH = "$env:RUNNER_TEMP;$env:PATH"

      - name: Start ngrok
        shell: pwsh
        run: |
          $env:PATH = "$env:RUNNER_TEMP;$env:PATH"
          ngrok config add-authtoken $env:NGROK_AUTHTOKEN
          Start-Process -FilePath ngrok -ArgumentList "tcp","3389","--log=stdout" -NoNewWindow -PassThru | Out-Null
          Start-Sleep -Seconds 6

      - name: Get Connection Info
        shell: pwsh
        id: conn
        run: |
          $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -Method Get
          $publicUrl = $tunnels.tunnels[0].public_url
          $addr = $publicUrl -replace '^tcp://',''
          echo "ADDRESS=$addr" >> $env:GITHUB_ENV
          Write-Host "Ket noi toi: $addr"

      - name: Summary
        shell: pwsh
        run: |
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '## Thong tin ket noi RDP Windows'
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ('- **Dia chi:** ' + $env:ADDRESS)
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '- **Username:** Administrator'
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ('- **Password:** ' + $env:RDP_PASSWORD)
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ''
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value 'Dung Remote Desktop (mstsc) nhap dia chi va dang nhap bang tai khoan tren.'
          if ($env:ADDRESS) {
            Write-Host "===== Thong tin dang nhap RDP ====="
            Write-Host "Dia chi: $env:ADDRESS"
            Write-Host "Username: Administrator"
            Write-Host "Password: $env:RDP_PASSWORD"
          }

      - name: Keep Alive
        shell: pwsh
        run: Start-Sleep -Seconds 21600
