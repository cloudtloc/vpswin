name: Windows VPS Cloudflare Ultra-Stable
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Cloudflared
        run: choco install cloudflared -y

      - name: Configure RDP & System Optimization
        run: |
          # 1. Cho phép Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          
          # 2. Tắt Firewall hoàn toàn
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
          
          # 3. Tối ưu hiệu suất (Thay thế lệnh bị lỗi)
          # Thiết lập Windows ưu tiên hiệu suất (Adjust for best performance)
          reg add "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v VisualFXSetting /t REG_DWORD /d 2 /f
          
          # 4. Đảm bảo dịch vụ RDP luôn chạy
          Set-Service TermService -StartupType Automatic
          Start-Service TermService -ErrorAction SilentlyContinue

      - name: Set Password
        run: |
          net user runneradmin Password123!
          net localgroup administrators runneradmin /add
        continue-on-error: true

      - name: Run Tunnel & Keep Alive
        run: |
          Write-Host "--- KHOI DONG CLOUDFLARE TUNNEL ---"
          $process = Start-Process cloudflared -ArgumentList "tunnel --no-autoupdate run --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" -PassThru
          
          Write-Host "--- VPS DA ONLINE TRÊN https://vps.tloc.cloud/ ---"
          
          $timeout = New-TimeSpan -Hours 6
          $stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
          
          while ($stopwatch.Elapsed -lt $timeout) {
              if ($process.HasExited) {
                  Write-Host "CANH BAO: Tunnel bi sap! Dang khoi dong lai..."
                  $process = Start-Process cloudflared -ArgumentList "tunnel --no-autoupdate run --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" -PassThru
              }
              $timeRemaining = $timeout - $stopwatch.Elapsed
              Write-Host "Uptime: $($stopwatch.Elapsed.ToString('hh\:mm\:ss')) | Con lai: $($timeRemaining.ToString('hh\:mm\:ss')) | Status: Connected"
              Start-Sleep -Seconds 30
          }
