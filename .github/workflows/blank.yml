name: Windows VPS via Cloudflare Tunnel
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Cloudflared
        run: choco install cloudflared -y

      - name: Enable Remote Desktop (RDP)
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0

      - name: Set Admin Password
        run: |
          $Password = "Password123!"
          $User = "runneradmin"
          net user $User $Password
          net localgroup administrators $User /add
          
          # Hiển thị thông tin đăng nhập ra Log
          Write-Host "===================================================="
          Write-Host "THONG TIN DANG NHAP VPS (CLOUDFLARE)"
          Write-Host "Username: .\$User"
          Write-Host "Password: $Password"
          Write-Host "Hostname: (Xem trong Cloudflare Zero Trust Dashboard)"
          Write-Host "===================================================="
        continue-on-error: true

      - name: Run Cloudflare Tunnel
        run: |
          Write-Host "Dang ket noi Tunnel... VPS se online trong giay lat."
          # Lenh nay se treo de giu VPS song 6 tieng
          cloudflared tunnel --no-autoupdate run --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
