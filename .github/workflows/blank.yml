name: Windows RDP (Optimized)
on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    env:
      NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
      # Mật khẩu RDP phải đủ mạnh theo chính sách Windows
      RDP_PASSWORD: Win2026A!
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        shell: pwsh
        run: |
          if (-not $env:NGROK_AUTHTOKEN) {
            Write-Error "Error: NGROK_AUTHTOKEN is missing in Secrets"
            exit 1
          }

      - name: Enable RDP with ngrok
        uses: NyaMisty/reverse-rdp-windows-github-actions-ng@master
        with:
          ngrok-token: ${{ env.NGROK_AUTHTOKEN }}
          password: ${{ env.RDP_PASSWORD }}

      - name: Summary
        shell: pwsh
        run: |
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '## Thông tin kết nối RDP Windows'
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '- Username: `runneradmin`'
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ('- Password: `' + $env:RDP_PASSWORD + '`')
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ''
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '### Cách lấy địa chỉ kết nối RDP'
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '- Đăng nhập `https://dashboard.ngrok.com/` bằng tài khoản ngrok.'
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '- Vào Cloud Edge -> Endpoints, lấy host:port của tunnel RDP.'
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '- Dùng Remote Desktop (mstsc) hoặc client RDP khác để kết nối.'
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ''
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '> Khi debug xong, xóa file `Delete-This-File-To-Continue.txt` trên Desktop của runner để workflow chạy tiếp.'
