name: Windows RDP 
on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    env:
      NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
      RDP_PASSWORD: Win2026A!
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        shell: pwsh
        run: |
          if (-not $env:NGROK_AUTHTOKEN) {
            Write-Error "Error: NGROK_AUTHTOKEN is missing in Secrets"
            exit 1
          }

      - name: Optimize Windows Performance & Visuals
        shell: pwsh
        run: |
          # 1. T·∫Øt hi·ªáu ·ª©ng ƒë·ªì h·ªça (Best Performance)
          $visualPath = 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects'
          if (-not (Test-Path $visualPath)) { New-Item -Path $visualPath -Force | Out-Null }
          Set-ItemProperty -Path $visualPath -Name VisualFXSetting -Value 2 -Force

          # 2. T·∫Øt Wallpaper v√† Animation
          Set-ItemProperty -Path 'HKCU:\Control Panel\Desktop' -Name Wallpaper -Value "" -Force
          Set-ItemProperty -Path 'HKCU:\Control Panel\Desktop\WindowMetrics' -Name MinAnimate -Value 0 -Force
          
          # 3. T·∫Øt Font Smoothing (ClearType) ƒë·ªÉ gi·∫£m t·∫£i render
          Set-ItemProperty -Path 'HKCU:\Control Panel\Desktop' -Name FontSmoothing -Value 0 -Force

          # 4. T·∫Øt d·ªãch v·ª• Audio (Remote Audio t·ªën bƒÉng th√¥ng)
          Stop-Service -Name Audiosrv -Force -ErrorAction SilentlyContinue
          Set-Service -Name Audiosrv -StartupType Disabled

          Write-Host "Windows Visuals optimized for Low Bandwidth."

      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup 'Remote Desktop' -ErrorAction SilentlyContinue
          
          # C·∫•u h√¨nh RDP t·ªëi ∆∞u bƒÉng th√¥ng
          $rdpPath = 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp'
          if (Test-Path $rdpPath) {
            Set-ItemProperty -Path $rdpPath -Name UserAuthentication -Value 1 -Force
            # Gi·ªõi h·∫°n color depth server side
            Set-ItemProperty -Path $rdpPath -Name ColorDepth -Value 3 -Force # 16-bit
          }
          
          $rdpUser = $env:USERNAME
          echo "RDP_USER=$rdpUser" >> $env:GITHUB_ENV
          net user $rdpUser $env:RDP_PASSWORD
          Write-Host "RDP enabled for User: $rdpUser"

      - name: Install ngrok
        shell: pwsh
        run: |
          $ngrokZip = "$env:RUNNER_TEMP\ngrok.zip"
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile $ngrokZip -UseBasicParsing
          Expand-Archive -Path $ngrokZip -DestinationPath $env:RUNNER_TEMP -Force
          $env:PATH = "$env:RUNNER_TEMP;$env:PATH"

      - name: Start ngrok (Region AP)
        shell: pwsh
        run: |
          $env:PATH = "$env:RUNNER_TEMP;$env:PATH"
          ngrok config add-authtoken $env:NGROK_AUTHTOKEN 2>&1 | Out-Null
          
          $ngrokExe = Join-Path $env:RUNNER_TEMP "ngrok.exe"
          $ngrokOut = Join-Path $env:RUNNER_TEMP "ngrok_out.log"
          $ngrokErr = Join-Path $env:RUNNER_TEMP "ngrok_err.log"
          
          # QUAN TR·ªåNG: Th√™m --region ap (Asia Pacific) ƒë·ªÉ gi·∫£m ping v·ªÅ VN
          Start-Process -FilePath $ngrokExe -ArgumentList "tcp","--region","ap","3389","--log=stdout" -NoNewWindow -PassThru -RedirectStandardOutput $ngrokOut -RedirectStandardError $ngrokErr
          
          $maxAttempts = 20
          $addr = $null
          for ($i = 0; $i -lt $maxAttempts; $i++) {
            Start-Sleep -Seconds 3
            try {
              $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -Method Get -ErrorAction Stop
              if ($tunnels.tunnels -and $tunnels.tunnels.Count -gt 0) {
                $addr = $tunnels.tunnels[0].public_url -replace '^tcp://',''
                break
              }
            } catch {}
          }

          if (-not $addr) { 
              Get-Content $ngrokErr
              Write-Error "Ngrok API failed."
              exit 1 
          }
          
          echo "ADDRESS=$addr" >> $env:GITHUB_ENV
          
          # Output th√¥ng tin
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '## üöÄ RDP Optimized (Asia Region)'
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ("- **Address:** $addr")
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ("- **User:** $env:RDP_USER")
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ("- **Pass:** $env:RDP_PASSWORD")
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ''
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '**L∆∞u √Ω Client:**'
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '1. V√†o mstsc -> Show Options -> Display: Ch·ªçn "High Color (16 bit)".'
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '2. Tab Experience: Ch·ªçn "Modem (56 kbps)". B·ªè tick T·∫§T C·∫¢.'
          
          Write-Host "::notice::RDP Address: $addr"

      - name: Keep Alive
        shell: pwsh
        run: |
          Write-Host "Press Ctrl+C to stop."
          $i = 0
          while ($true) {
            $i++
            # In ra m·ªói 60s ƒë·ªÉ tr√°nh b·ªã GitHub timeout log
            if ($i % 60 -eq 0) { Write-Host "Session active for $i seconds..." }
            Start-Sleep -Seconds 1
            if ($i -ge 21600) { break } # 6 hours limit
          }
