name: Windows VPS Cloudflare Ultra-Stable
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Cloudflared
        run: choco install cloudflared -y

      - name: Configure RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          # Đảm bảo dịch vụ RDP luôn chạy
          Set-Service TermService -StartupType Automatic
          Start-Service TermService -ErrorAction SilentlyContinue

      - name: Set Password
        run: |
          net user runneradmin Password123!
          net localgroup administrators runneradmin /add
        continue-on-error: true

      - name: Run Tunnel & Keep Alive
        run: |
          Write-Host "Khoi dong Tunnel..."
          # Chạy tunnel ở chế độ nền (Background)
          $process = Start-Process cloudflared -ArgumentList "tunnel --no-autoupdate run --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" -PassThru
          
          Write-Host "VPS Online! Dang duy tri ket noi trong 6 tieng..."
          # Vòng lặp in log moi 30s de GitHub khong ngat ket noi do idle
          $timeout = New-TimeSpan -Hours 6
          $stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
          while ($stopwatch.Elapsed -lt $timeout) {
              if ($process.HasExited) {
                  Write-Host "CANH BAO: Tunnel bi sap! Dang khoi dong lai..."
                  $process = Start-Process cloudflared -ArgumentList "tunnel --no-autoupdate run --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" -PassThru
              }
              Write-Host "Thoi gian da chay: $($stopwatch.Elapsed.ToString('hh\:mm\:ss')) - Trang thai: On-air"
              Start-Sleep -Seconds 30
          }
