name: Windows VPS Cloudflare Ultra-Stable
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Cloudflared
        run: choco install cloudflared -y

      - name: Setup Windows RDP & User
        run: |
          # 1. Cho phép RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
          
          # 2. Tạo Password & Kiểm tra User (Tránh lỗi 1378)
          $Password = ConvertTo-SecureString "Password123!" -AsPlainText -Force
          $User = "runneradmin"
          net user $User Password123!
          if (!(Get-LocalGroupMember -Group "Administrators" | Where-Object {$_.Name -like "*$User*"})) {
              Add-LocalGroupMember -Group "Administrators" -Member $User
          }
          
          # 3. Khởi động dịch vụ RDP
          Start-Service TermService

      - name: Run Tunnel & Keep Alive
        run: |
          Write-Host "--- DANG KET NOI TUNNEL ---"
          # Chạy tunnel
          $process = Start-Process cloudflared -ArgumentList "tunnel --no-autoupdate run --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" -PassThru
          
          $timeout = New-TimeSpan -Hours 6
          $stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
          
          while ($stopwatch.Elapsed -lt $timeout) {
              if ($process.HasExited) {
                  Write-Host "Tunnel bi ngat, dang khoi dong lai..."
                  $process = Start-Process cloudflared -ArgumentList "tunnel --no-autoupdate run --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" -PassThru
              }
              Write-Host "Trang thai: Dang hoat dong | Uptime: $($stopwatch.Elapsed.ToString('hh\:mm\:ss'))"
              Start-Sleep -Seconds 30
          }
