name: Windows
on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    env:
      NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
      # Mật khẩu RDP phải đủ mạnh theo chính sách Windows
      RDP_PASSWORD: Win2026A!
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        shell: pwsh
        run: |
          if (-not $env:NGROK_AUTHTOKEN) {
            Write-Error "Error: NGROK_AUTHTOKEN is missing in Secrets"
            exit 1
          }

      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup 'Remote Desktop' -ErrorAction SilentlyContinue
          New-NetFirewallRule -DisplayName 'RDP 3389' -Direction Inbound -Protocol TCP -LocalPort 3389 -Action Allow -ErrorAction SilentlyContinue
          $rdpPath = 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp'
          if (Test-Path $rdpPath) {
            Set-ItemProperty -Path $rdpPath -Name ColorDepth -Value 2 -Force
            Set-ItemProperty -Path $rdpPath -Name fInheritMaxSessionTime -Value 0 -Force
            Set-ItemProperty -Path $rdpPath -Name MaxIdleTime -Value 0 -Force
          }
          $rdpUser = $env:USERNAME
          echo "RDP_USER=$rdpUser" >> $env:GITHUB_ENV
          net user $rdpUser $env:RDP_PASSWORD
          Write-Host "RDP enabled. User: $rdpUser"

      - name: Install ngrok
        shell: pwsh
        run: |
          $ngrokZip = "$env:RUNNER_TEMP\ngrok.zip"
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile $ngrokZip -UseBasicParsing
          Expand-Archive -Path $ngrokZip -DestinationPath $env:RUNNER_TEMP -Force
          $env:PATH = "$env:RUNNER_TEMP;$env:PATH"

      - name: Start ngrok, get URL and keep alive
        shell: pwsh
        run: |
          $env:PATH = "$env:RUNNER_TEMP;$env:PATH"
          ngrok config add-authtoken $env:NGROK_AUTHTOKEN 2>&1 | Out-Null
          $ngrokExe = Join-Path $env:RUNNER_TEMP "ngrok.exe"
          $ngrokOut = Join-Path $env:RUNNER_TEMP "ngrok_out.log"
          $ngrokErr = Join-Path $env:RUNNER_TEMP "ngrok_err.log"
          Start-Process -FilePath $ngrokExe -ArgumentList "tcp","3389","--log=stdout" -NoNewWindow -PassThru -RedirectStandardOutput $ngrokOut -RedirectStandardError $ngrokErr
          $maxAttempts = 15
          $addr = $null
          for ($i = 0; $i -lt $maxAttempts; $i++) {
            Start-Sleep -Seconds 2
            try {
              $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -Method Get -ErrorAction Stop
              if ($tunnels.tunnels -and $tunnels.tunnels.Count -gt 0) {
                $addr = $tunnels.tunnels[0].public_url -replace '^tcp://',''
                break
              }
            } catch {}
          }
          if (-not $addr) { Write-Error "Ngrok API khong phan hoi sau $maxAttempts lan thu."; exit 1 }
          echo "ADDRESS=$addr" >> $env:GITHUB_ENV
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '## Thong tin ket noi RDP Windows'
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ("- **Dia chi:** $addr")
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ("- **Username:** $env:RDP_USER")
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ("- **Password:** $env:RDP_PASSWORD")
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ''
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value 'Dung Remote Desktop (mstsc) nhap dia chi va dang nhap bang tai khoan tren.'
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ''
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '**Giam giat:** Trong mstsc chon Show Options -> Experience: chon "Low bandwidth (56 kbps)" hoac bo tick "Desktop composition" va "Animate windows"; mau 16-bit.'
          Write-Host "===== Thong tin dang nhap RDP ====="
          Write-Host "Dia chi: $addr"
          Write-Host "Username: $env:RDP_USER"
          Write-Host "Password: $env:RDP_PASSWORD"
          Start-Sleep -Seconds 21600
